{
  "info": {
    "name": "Post-Build Auth Integration Tests",
    "description": "Phase 1: Authentication API post-build integration tests for QuizMaker.\n\nCovers registration, login, session verification, and logout against a running instance.\n\nTest naming convention:\n- \"[Feature] - [Endpoint/Action] - [Scenario / Expected Outcome]\"\nExample: \"Auth - POST /api/auth/register - valid registration creates user (201 or 409)\".",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "authTestEmail",
      "value": "integration.teacher1@example.com"
    },
    {
      "key": "authTestUsername",
      "value": "integration_teacher_1"
    },
    {
      "key": "authTestPassword",
      "value": "IntegrationTestPassword123!"
    }
  ],
  "item": [
    {
      "name": "Auth - User Registration",
      "item": [
        {
          "name": "Auth - POST /api/auth/register - valid registration creates or reuses test user (201 or 409)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"firstName\": \"Integration\",\n  \"lastName\": \"Teacher\",\n  \"username\": \"{{authTestUsername}}\",\n  \"email\": \"{{authTestEmail}}\",\n  \"password\": \"{{authTestPassword}}\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/auth/register",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "auth",
                "register"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Auth - POST /api/auth/register - valid registration creates or reuses test user (201 or 409)",
                  "",
                  "const status = pm.response.code;",
                  "",
                  "pm.test(\"Auth - register - status is 201 (created) or 409 (already exists)\", function () {",
                  "  pm.expect(status).to.be.oneOf([201, 409]);",
                  "});",
                  "",
                  "if (status === 201 || status === 409) {",
                  "  // When available, capture returned user id for debugging",
                  "  try {",
                  "    const json = pm.response.json();",
                  "    if (json && json.id) {",
                  "      pm.environment.set(\"authTestUserId\", json.id);",
                  "    }",
                  "  } catch (e) {",
                  "    // Response may be empty on 409; ignore parse errors",
                  "  }",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Auth - POST /api/auth/register - duplicate username returns 409",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"firstName\": \"Integration\",\n  \"lastName\": \"Teacher\",\n  \"username\": \"{{authTestUsername}}\",\n  \"email\": \"another+username-dup@example.com\",\n  \"password\": \"{{authTestPassword}}\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/auth/register",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "auth",
                "register"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Auth - POST /api/auth/register - duplicate username returns 409",
                  "",
                  "pm.test(\"Auth - register - duplicate username returns 409\", function () {",
                  "  pm.response.to.have.status(409);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Auth - POST /api/auth/register - duplicate email returns 409",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"firstName\": \"Integration\",\n  \"lastName\": \"Teacher\",\n  \"username\": \"another_username_dup\",\n  \"email\": \"{{authTestEmail}}\",\n  \"password\": \"{{authTestPassword}}\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/auth/register",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "auth",
                "register"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Auth - POST /api/auth/register - duplicate email returns 409",
                  "",
                  "pm.test(\"Auth - register - duplicate email returns 409\", function () {",
                  "  pm.response.to.have.status(409);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Auth - POST /api/auth/register - missing required field returns 400",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"firstName\": \"Integration\",\n  \"lastName\": \"Teacher\",\n  \"username\": \"missing_email_user\",\n  \"password\": \"{{authTestPassword}}\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/auth/register",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "auth",
                "register"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Auth - POST /api/auth/register - missing required field returns 400",
                  "",
                  "pm.test(\"Auth - register - missing email returns 400\", function () {",
                  "  pm.response.to.have.status(400);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Auth - POST /api/auth/register - invalid email format returns 400",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"firstName\": \"Integration\",\n  \"lastName\": \"Teacher\",\n  \"username\": \"invalid_email_user\",\n  \"email\": \"not-an-email\",\n  \"password\": \"{{authTestPassword}}\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/auth/register",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "auth",
                "register"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Auth - POST /api/auth/register - invalid email format returns 400",
                  "",
                  "pm.test(\"Auth - register - invalid email format returns 400\", function () {",
                  "  pm.response.to.have.status(400);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Auth - POST /api/auth/register - weak password rejected by validation",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"firstName\": \"Integration\",\n  \"lastName\": \"Teacher\",\n  \"username\": \"weak_password_user\",\n  \"email\": \"weak.password.user@example.com\",\n  \"password\": \"short\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/auth/register",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "auth",
                "register"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Auth - POST /api/auth/register - weak password rejected by validation",
                  "",
                  "pm.test(\"Auth - register - weak password returns 400\", function () {",
                  "  pm.response.to.have.status(400);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Auth - User Login",
      "item": [
        {
          "name": "Auth - POST /api/auth/login - login with username succeeds (200)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"usernameOrEmail\": \"{{authTestUsername}}\",\n  \"password\": \"{{authTestPassword}}\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/auth/login",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "auth",
                "login"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Auth - POST /api/auth/login - login with username succeeds (200)",
                  "",
                  "pm.test(\"Auth - login with username returns 200\", function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "// Capture session_token cookie for subsequent authenticated requests",
                  "const sessionCookie = pm.cookies.get('session_token');",
                  "if (sessionCookie) {",
                  "  pm.environment.set('authSessionCookie', sessionCookie);",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Auth - POST /api/auth/login - login with email succeeds (200)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"usernameOrEmail\": \"{{authTestEmail}}\",\n  \"password\": \"{{authTestPassword}}\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/auth/login",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "auth",
                "login"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Auth - POST /api/auth/login - login with email succeeds (200)",
                  "",
                  "pm.test(\"Auth - login with email returns 200\", function () {",
                  "  pm.response.to.have.status(200);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Auth - POST /api/auth/login - invalid credentials return 401",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"usernameOrEmail\": \"{{authTestUsername}}\",\n  \"password\": \"WrongPassword!\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/auth/login",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "auth",
                "login"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Auth - POST /api/auth/login - invalid credentials return 401",
                  "",
                  "pm.test(\"Auth - login - invalid credentials returns 401\", function () {",
                  "  pm.response.to.have.status(401);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Auth - POST /api/auth/login - missing fields return 400",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"password\": \"{{authTestPassword}}\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/api/auth/login",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "auth",
                "login"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Auth - POST /api/auth/login - missing fields return 400",
                  "",
                  "pm.test(\"Auth - login - missing usernameOrEmail returns 400\", function () {",
                  "  pm.response.to.have.status(400);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Auth - Session & Current User",
      "item": [
        {
          "name": "Auth - GET /api/auth/me - valid session returns current user",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Cookie",
                "value": "session_token={{authSessionCookie}}",
                "disabled": false
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/auth/me",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "auth",
                "me"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Auth - GET /api/auth/me - valid session returns current user",
                  "",
                  "pm.test(\"Auth - me - valid session returns 200\", function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test(\"Auth - me - response includes basic user fields\", function () {",
                  "  const json = pm.response.json();",
                  "  pm.expect(json).to.have.property('id');",
                  "  pm.expect(json).to.have.property('firstName');",
                  "  pm.expect(json).to.have.property('lastName');",
                  "  pm.expect(json).to.have.property('username');",
                  "  pm.expect(json).to.have.property('email');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Auth - GET /api/auth/me - no session cookie returns 401",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/auth/me",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "auth",
                "me"
              ]
            },
            "protocolProfileBehavior": {
              "disableCookies": true
            }
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Logout to invalidate session server-side, then clear cookies",
                  "// This ensures even if a cookie somehow gets sent, the session is invalid",
                  "const sessionCookie = pm.environment.get('authSessionCookie');",
                  "if (sessionCookie) {",
                  "  pm.sendRequest({",
                  "    url: pm.environment.get('baseUrl') + '/api/auth/logout',",
                  "    method: 'POST',",
                  "    header: { 'Cookie': 'session_token=' + sessionCookie }",
                  "  }, function(err, response) {",
                  "    // Ignore errors - session may already be invalid",
                  "  });",
                  "}",
                  "// Clear all cookies and remove Cookie header",
                  "const url = pm.request.url.toString();",
                  "pm.cookies.jar().clear(url, function(err) {",
                  "  if (err) console.error('Error clearing cookies:', err);",
                  "});",
                  "pm.request.headers.remove('Cookie');"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Auth - GET /api/auth/me - no session cookie returns 401",
                  "",
                  "pm.test(\"Auth - me - no session returns 401\", function () {",
                  "  pm.response.to.have.status(401);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Auth - POST /api/auth/verify-session - valid session returns 200",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Cookie",
                "value": "session_token={{authSessionCookie}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/auth/verify-session",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "auth",
                "verify-session"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Auth - POST /api/auth/verify-session - valid session returns 200",
                  "",
                  "pm.test(\"Auth - verify-session - valid session returns 200\", function () {",
                  "  pm.response.to.have.status(200);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Auth - POST /api/auth/verify-session - invalid session returns 401",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Cookie",
                "value": "session_token=invalid_or_expired_session_token"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/auth/verify-session",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "auth",
                "verify-session"
              ]
            },
            "protocolProfileBehavior": {
              "disableCookies": true
            }
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Logout to invalidate session server-side before testing invalid session",
                  "const sessionCookie = pm.environment.get('authSessionCookie');",
                  "if (sessionCookie) {",
                  "  pm.sendRequest({",
                  "    url: pm.environment.get('baseUrl') + '/api/auth/logout',",
                  "    method: 'POST',",
                  "    header: { 'Cookie': 'session_token=' + sessionCookie }",
                  "  }, function(err, response) {",
                  "    // Ignore errors - session may already be invalid",
                  "  });",
                  "}",
                  "// Clear all cookies from jar to ensure only the manually set invalid cookie header is sent",
                  "const url = pm.request.url.toString();",
                  "pm.cookies.jar().clear(url, function(err) {",
                  "  if (err) console.error('Error clearing cookies:', err);",
                  "});"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Auth - POST /api/auth/verify-session - invalid session returns 401",
                  "",
                  "pm.test(\"Auth - verify-session - invalid session returns 401\", function () {",
                  "  pm.response.to.have.status(401);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Auth - Logout",
      "item": [
        {
          "name": "Auth - POST /api/auth/logout - clears session and returns 200",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Cookie",
                "value": "session_token={{authSessionCookie}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/auth/logout",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "auth",
                "logout"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Auth - POST /api/auth/logout - clears session and returns 200",
                  "",
                  "pm.test(\"Auth - logout - valid session returns 200\", function () {",
                  "  pm.response.to.have.status(200);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Auth - POST /api/auth/logout - repeated logout is safely handled",
          "request": {
            "method": "POST",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/auth/logout",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "api",
                "auth",
                "logout"
              ]
            },
            "protocolProfileBehavior": {
              "disableCookies": true
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Auth - POST /api/auth/logout - repeated logout is safely handled",
                  "",
                  "pm.test(\"Auth - logout - repeated logout does not error (200 or 401)\", function () {",
                  "  pm.expect(pm.response.code).to.be.oneOf([200, 401]);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    }
  ]
}

